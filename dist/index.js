(()=>{"use strict";var e={603:(e,o,t)=>{Object.defineProperty(o,"__esModule",{value:!0}),o.artifactUploadedMain=void 0;const r=t(326),a=t(99);o.artifactUploadedMain=async e=>{const{downloadID:o,isDev:t}=e,{notificationEmail:s}=await a.getVideoDoc(o,t);await a.updateVideoDoc(o,{downloadStatus:"finished"},t),await r.sendSuccessEmail(s,o,t)}},312:(e,o)=>{Object.defineProperty(o,"__esModule",{value:!0}),o.MAX_YOUTUBE_DL_ATTEMPTS=o.downloadDestDir=o.downloadasaurAddressObject=o.downloadasaurEmail=o.UNKNOWN_ARGS_MSG=o.exitCodes=void 0,o.exitCodes={UNKNOWN_ERROR:1,FIRESTORE_GITHUB_ACTION_UPDATE_ERROR:10,YOUTUBE_DL_SETUP_ERROR:11,YOUTUBE_DL_RUN_ERROR:12,UNKNOWN_ARGS:20},o.UNKNOWN_ARGS_MSG="Unknown arguments, only `youtubedl` and `artifactUploaded` accepted",o.downloadasaurEmail="hello@downloadasaur.com",o.downloadasaurAddressObject={name:"Downloadasaur",address:o.downloadasaurEmail},o.downloadDestDir="downloaded",o.MAX_YOUTUBE_DL_ATTEMPTS=3},326:function(e,o,t){var r=this&&this.__createBinding||(Object.create?function(e,o,t,r){void 0===r&&(r=t),Object.defineProperty(e,r,{enumerable:!0,get:function(){return o[t]}})}:function(e,o,t,r){void 0===r&&(r=t),e[r]=o[t]}),a=this&&this.__setModuleDefault||(Object.create?function(e,o){Object.defineProperty(e,"default",{enumerable:!0,value:o})}:function(e,o){e.default=o}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var o={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&r(o,e,t);return a(o,e),o},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0}),o.sendSuccessEmail=o.sendErrorEmail=void 0;const i=n(t(123)),d=t(593),l=t(312),u=s(t(787));o.sendErrorEmail=async(e,o,t)=>{if(void 0!==e&&e.length>0){console.log("Sending error email");const r=f(o,t);await p(e,"Downloadasaur: Download Failed",r)}else console.log("No notificationEmail, not sending error email")},o.sendSuccessEmail=async(e,o,t)=>{if(void 0!==e&&e.length>0){console.log("Sending sucess email");const r=c(o,t);await p(e,"Downloadasaur: Download Complete",r)}else console.log("No notificationEmail, not sending success email")};const c=(e,o)=>`Hello!\n\nYour video was downloaded successfully. You can download it here: ${d.getClientUrl(o)}/download?download_id=${e}\n\n- The Downloadasaur Team`,f=(e,o)=>`Hello!\n  \nWe're sorry to inform you that your download failed. More details can be found here: ${d.getClientUrl(o)}/download?download_id=${e}\n  \n- The Downloadasaur Team`,p=async(e,o,t)=>{try{const r=new u.SES({apiVersion:"2010-12-01",region:"eu-west-1"}),a=i.default.createTransport({SES:{ses:r,aws:u}}),s={from:`Downloadasaur ${l.downloadasaurEmail}`,to:e,subject:o,text:t},n=await a.sendMail(s);console.log(`Email sent: ${n.response}`)}catch(e){console.log(`Failed to send email: ${e}`),console.error(e)}}},99:function(e,o,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0}),o.getVideoDoc=o.updateVideoDoc=o.getFirestoreCollections=o.firestore=o.firebaseApp=void 0;const a=r(t(54));o.firebaseApp=process.env.FIREBASE_CREDENTIALS?a.default.initializeApp({credential:a.default.credential.cert(JSON.parse(process.env.FIREBASE_CREDENTIALS))}):a.default.initializeApp(),o.firestore=o.firebaseApp.firestore(),o.firestore.settings({ignoreUndefinedProperties:!0}),o.getFirestoreCollections=e=>({videoDownloads:e?"dev-video-downloads":"video-downloads",users:e?"dev-users":"users"}),o.updateVideoDoc=async function(e,t,r){await o.firestore.collection(o.getFirestoreCollections(r).videoDownloads).doc(e).update(t)},o.getVideoDoc=async function(e,t){const r=(await o.firestore.collection(o.getFirestoreCollections(t).videoDownloads).doc(e).get()).data();if(!r)throw new Error(`Doc data is falsey for doc id ${e}!! This should never happen`);return r}},607:function(e,o,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0});const a=t(603),s=t(312),n=t(610),i=r(t(334)),d=t(128);(async()=>{const e=process.argv.slice(2);if(2!==e.length)throw new Error(s.UNKNOWN_ARGS_MSG);const o=e[0],t=JSON.parse(Buffer.from(e[1],"base64").toString()),{isDev:r}=t;if(r&&i.default.config(),"youtubedl"===o)await n.youtubeDLMain(t);else if("artifactUploaded"===o)await a.artifactUploadedMain(t);else{if("recovery"!==o)throw new Error(s.UNKNOWN_ARGS_MSG);await d.recoveryMain(t)}})().catch((e=>{console.error(e),process.exit(s.exitCodes.UNKNOWN_ERROR)}))},128:function(e,o,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0}),o.recoveryMain=void 0;const a=t(312),s=t(326),n=t(99),i=r(t(747));o.recoveryMain=async e=>{i.default.existsSync("SUCCESS.TXT")?console.log("The youtube-dl action succeeded, so there is no need to recover"):await async function(e){let o;const{downloadID:t,isDev:r}=e;try{const e=await n.getVideoDoc(t,r);if(o=e.notificationEmail,"error"===e.downloadStatus)return void console.log("There is no need to set an error status again, because it was already written to firestore successfully");throw new Error("Job failed halfway without setting firestore status to error")}catch(e){console.error(e),await s.sendErrorEmail(o,t,r),await n.updateVideoDoc(t,{errorMsg:"Unknown error, reported in recovery step",errorCode:a.exitCodes.UNKNOWN_ERROR,downloadStatus:"error"},r)}}(e)}},593:(e,o)=>{Object.defineProperty(o,"__esModule",{value:!0}),o.getClientUrl=o.getEnvVarOrThrow=void 0,o.getEnvVarOrThrow=e=>{const o=process.env[e];if(o)return o;throw new Error(`${e} env var not set`)},o.getClientUrl=e=>e?"http://localhost:3000":"https://downloadasaur.com"},610:function(e,o,t){var r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0}),o.youtubeDLMain=o.createYtdlConfig=void 0;const a=t(312),s=t(129),n=r(t(927)),i=t(99),d=t(326),l=r(t(101));function u(e){var o,t;let r="",s="";var n;(n=e.formatSettings).ytdlFormatSettings&&!n.audioOutputFormat&&(r=e.formatSettings.ytdlFormatSettings.formatCode),function(e){return!!e.mergeOutputFormat}(e.formatSettings)&&(r=`${null===(o=e.formatSettings.ytdlVideoFormatSettings)||void 0===o?void 0:o.formatCode}+${null===(t=e.formatSettings.ytdlAudioFormatSettings)||void 0===t?void 0:t.formatCode}`,s=`--merge-output-format ${e.formatSettings.mergeOutputFormat}`),function(e){return!!e.audioOutputFormat}(e.formatSettings)&&(r=e.formatSettings.ytdlFormatSettings.formatCode,"audio"===e.formatSettings.ytdlFormatSettings.mode&&"best"===e.formatSettings.audioOutputFormat||(s=`--extract-audio --audio-format ${e.formatSettings.audioOutputFormat}`)),function(e){return!!e.videoSubtitlesSettings&&!e.ytdlFormatSettings&&!e.mergeOutputFormat}(e.formatSettings)&&(s="--skip-download"),function(e){return!!e.videoSubtitlesSettings}(e.formatSettings)&&(s+=` --write-sub --write-auto-sub --sub-format ${e.formatSettings.videoSubtitlesSettings.fileExtension} --sub-lang ${e.formatSettings.videoSubtitlesSettings.languageCode}`);const i=`${r?"-f":""} ${r} ${s} -o ./${a.downloadDestDir}/%(title)s-%(id)s.%(ext)s ${e.videoUrl}`.split(/[ ,]+/);return l.default(i)}o.createYtdlConfig=u;const c=async e=>{const o=`./youtube-dl ${e}`;return console.log("Youtube-dl exec string: ",o),new Promise(((e,t)=>{s.exec(o,{cwd:n.default.path,timeout:36e5,maxBuffer:1073741824},((o,r,a)=>{o&&(console.error(`runYoutubeDL error: ${o.message}`),t(o.message)),a&&(console.error(`runYoutubeDL stderr: ${a}`),t(a)),console.log(`runYoutubeDL stdout: ${r}`),e({})}))}))};o.youtubeDLMain=async e=>{var o;const{downloadID:t,youtubeDLConfig:r,isDev:l}=e;console.log("Download ID: ",t),console.log("youtube-dl config: ",r);const{notificationEmail:f}=await i.getVideoDoc(t,l);try{await i.updateVideoDoc(t,{githubActionRunID:process.env.GITHUB_ACTION_RUN_ID?parseInt(null!==(o=process.env.GITHUB_ACTION_RUN_ID)&&void 0!==o?o:0):0,downloadStatus:"processing"},l)}catch(e){console.error(e),await i.updateVideoDoc(t,{errorMsg:e.message,errorCode:a.exitCodes.FIRESTORE_GITHUB_ACTION_UPDATE_ERROR,downloadStatus:"error"},l),await d.sendErrorEmail(f,t,l),process.exit(a.exitCodes.FIRESTORE_GITHUB_ACTION_UPDATE_ERROR)}try{await(async()=>new Promise(((e,o)=>{s.exec("\n      rm -f youtube-dl;\n      curl -LJO https://github.com/ytdl-org/youtube-dl/releases/latest/download/youtube-dl; \n      chmod +x ./youtube-dl\n      ",{cwd:n.default.path,timeout:12e4},((t,r,a)=>{t&&(console.error(`setupYoutubeDL error: ${t.message}`),o(t.message)),a&&console.error(`setupYoutubeDL stderr: ${a}`),console.log(`setupYoutubeDL stdout: ${r}`),e({})}))})))()}catch(e){console.error(e),await i.updateVideoDoc(t,{errorMsg:e.message,errorCode:a.exitCodes.YOUTUBE_DL_SETUP_ERROR,downloadStatus:"error"},l),await d.sendErrorEmail(f,t,l),process.exit(a.exitCodes.YOUTUBE_DL_SETUP_ERROR)}try{await(async(e,o=a.MAX_YOUTUBE_DL_ATTEMPTS)=>{for(let t=1;t<=o;++t){console.log(`Attempt ${t}/${o}`);try{return await c(e),void console.log(`Attempt ${t}/${o} succeeded`)}catch(e){console.error(`Attempt ${t}/${o} failed with: ${e}`)}}throw new Error(`Failed after ${o} attempts`)})(u(r))}catch(e){console.error("Error caught: ",e),await i.updateVideoDoc(t,{errorMsg:e.message,errorCode:a.exitCodes.YOUTUBE_DL_RUN_ERROR,downloadStatus:"error"},l),await d.sendErrorEmail(f,t,l),process.exit(a.exitCodes.YOUTUBE_DL_RUN_ERROR)}}},787:e=>{e.exports=require("@aws-sdk/client-ses")},927:e=>{e.exports=require("app-root-path")},129:e=>{e.exports=require("child_process")},334:e=>{e.exports=require("dotenv")},54:e=>{e.exports=require("firebase-admin")},747:e=>{e.exports=require("fs")},123:e=>{e.exports=require("nodemailer")},101:e=>{e.exports=require("shell-escape")}},o={};!function t(r){var a=o[r];if(void 0!==a)return a.exports;var s=o[r]={exports:{}};return e[r].call(s.exports,s,s.exports,t),s.exports}(607)})();